<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Menús para Juegos - Generador de JSON</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 10px; }
        #container { display: flex; height: 100vh; }
        #canvasContainer { 
            border: 1px solid black; 
            overflow: auto; 
            flex: 1; 
            max-width: calc(100vw - 320px);
        }
        #canvas { 
            display: block; 
            border: 1px solid gray; 
            cursor: default;
        }
        #controls { 
            width: 300px; 
            padding: 10px; 
            overflow-y: auto;
            background: #f5f5f5;
        }
        .viewBtn { margin: 5px 0; padding: 5px 10px; }
        #urlInput { width: 100%; margin-bottom: 5px; padding: 5px; }
        button { margin: 2px; padding: 5px; }
        #imageList div { margin-bottom: 10px; border: 1px solid #ddd; padding: 5px; }
        #imageList input { width: 150px; margin-right: 5px; }
        .toolBtn { width: 100%; margin: 5px 0; }
        input[type="radio"] { margin-right: 5px; }
    </style>
</head>
<body>
    <div id="container">
        <div id="canvasContainer">
            <canvas id="canvas"></canvas>
        </div>
        <div id="controls">
            <h3>Vista</h3>
            <button class="viewBtn" onclick="setView('pc')">PC Horizontal (1920x1080)</button>
            <button class="viewBtn" onclick="setView('mobileH')">Móvil Horizontal (800x480)</button>
            <button class="viewBtn" onclick="setView('mobileV')">Móvil Vertical (480x800)</button>
            
            <h3>Herramientas</h3>
            <label><input type="radio" name="tool" value="modificador" checked onchange="selectTool('modificador')"> Modificador</label><br>
            <label><input type="radio" name="tool" value="zoom" onchange="selectTool('zoom')"> Zoom de Imagen</label>
            
            <h3>Añadir Imagen</h3>
            <input type="text" id="urlInput" placeholder="Colocar URL de la imagen (GIF, PNG, etc.)">
            <button onclick="loadImage()">Cargar Imagen</button>
            
            <h3>Cuadros</h3>
            <div id="imageList"></div>
            
            <button onclick="saveJSON()" style="margin-top: 20px; width: 100%;">Guardar JSON</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let images = [];
        let currentView = 'pc';
        let zoom = 1;
        let selectedImage = null;
        let currentTool = 'modificador';
        let mode = 'none';
        let startX, startY;
        let logicalW, logicalH;
        let pivotRelX, pivotRelY, initialDist;

        const views = {
            'pc': { w: 1920, h: 1080 },
            'mobileH': { w: 800, h: 480 },
            'mobileV': { w: 480, h: 800 }
        };

        function selectTool(tool) {
            currentTool = tool;
            mode = 'none';
            canvas.style.cursor = 'default';
            draw();
        }

        function setView(viewName) {
            currentView = viewName;
            zoom = 1;
            updateCanvasSize();
            updateList();
        }

        function updateCanvasSize() {
            logicalW = views[currentView].w;
            logicalH = views[currentView].h;
            const displayW = logicalW * zoom;
            const displayH = logicalH * zoom;
            canvas.width = displayW;
            canvas.height = displayH;
            canvas.style.width = displayW + 'px';
            canvas.style.height = displayH + 'px';
            draw();
        }

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            const scale = zoom;
            return {
                x: (e.clientX - rect.left) / scale,
                y: (e.clientY - rect.top) / scale
            };
        }

        function getLogicalPosFromPercent(percentX, percentY) {
            return {
                x: (percentX / 100) * logicalW,
                y: (percentY / 100) * logicalH
            };
        }

        function getImageAt(mx, my) {
            for (let i = images.length - 1; i >= 0; i--) {
                const img = images[i];
                if (!img.img || !img.img.complete) continue;
                const { x: left, y: top } = getLogicalPosFromPercent(img.x, img.y);
                const width = (img.ancho / 100) * logicalW;
                const height = (img.alto / 100) * logicalH;
                const right = left + width;
                const bottom = top + height;
                if (mx >= left && mx <= right && my >= top && bottom >= my) {
                    return img;
                }
            }
            return null;
        }

        function getHandleAt(img, mx, my) {
            const handleScreenSize = 10;
            const logicalHandleSize = handleScreenSize / zoom;
            const half = logicalHandleSize / 2;
            const { x: left, y: top } = getLogicalPosFromPercent(img.x, img.y);
            const width = (img.ancho / 100) * logicalW;
            const height = (img.alto / 100) * logicalH;
            const right = left + width;
            const bottom = top + height;

            // NW
            if (mx >= left - half && mx <= left + half && my >= top - half && my <= top + half) return 'nw';
            // NE
            if (mx >= right - half && mx <= right + half && my >= top - half && my <= top + half) return 'ne';
            // SW
            if (mx >= left - half && mx <= left + half && my >= bottom - half && my <= bottom + half) return 'sw';
            // SE
            if (mx >= right - half && mx <= right + half && my >= bottom - half && my <= bottom + half) return 'se';
            return null;
        }

        function getCursorForHandle(handle) {
            return (handle === 'nw' || handle === 'se') ? 'nwse-resize' : 'nesw-resize';
        }

        canvas.addEventListener('mousedown', (e) => {
            const pos = getMousePos(e);
            if (currentTool === 'zoom') {
                selectedImage = getImageAt(pos.x, pos.y);
                if (!selectedImage) return;
                mode = 'zoom';
                const { x: left, y: top } = getLogicalPosFromPercent(selectedImage.x, selectedImage.y);
                const width = (selectedImage.ancho / 100) * logicalW;
                const height = (selectedImage.alto / 100) * logicalH;
                pivotRelX = (pos.x - left) / width;
                pivotRelY = (pos.y - top) / height;
                startX = pos.x;
                startY = pos.y;
                initialDist = Math.sqrt((pos.x - startX)**2 + (pos.y - startY)**2); // Initial dist 0, but will use in move
                canvas.style.cursor = 'zoom-in';
            } else { // modificador
                selectedImage = getImageAt(pos.x, pos.y);
                if (!selectedImage) {
                    mode = 'none';
                    draw();
                    return;
                }
                const handle = getHandleAt(selectedImage, pos.x, pos.y);
                mode = handle || 'drag';
                startX = pos.x;
                startY = pos.y;
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            const pos = getMousePos(e);
            if (mode !== 'none') {
                if (currentTool === 'zoom' && mode === 'zoom') {
                    const dx = pos.x - startX;
                    const dy = pos.y - startY;
                    const currentDist = Math.sqrt(dx*dx + dy*dy);
                    let scale = 1;
                    if (initialDist > 0) {
                        scale = currentDist / initialDist;
                    } else {
                        // First move, use a base scale based on distance
                        scale = 1 + (currentDist / 100); // Arbitrary sensitivity
                    }
                    if (scale < 0.1) scale = 0.1; // Min scale
                    const oldWidth = (selectedImage.ancho / 100) * logicalW;
                    const oldHeight = (selectedImage.alto / 100) * logicalH;
                    const newWidth = oldWidth * scale;
                    const newHeight = oldHeight * scale;
                    const newLeft = startX - pivotRelX * newWidth;
                    const newTop = startY - pivotRelY * newHeight;
                    selectedImage.x = (newLeft / logicalW) * 100;
                    selectedImage.y = (newTop / logicalH) * 100;
                    selectedImage.ancho = (newWidth / logicalW) * 100;
                    selectedImage.alto = (newHeight / logicalH) * 100;
                    startX = pos.x; // Update start for continuous
                    startY = pos.y;
                    initialDist = currentDist;
                    draw();
                } else if (mode === 'drag') {
                    const dx = pos.x - startX;
                    const dy = pos.y - startY;
                    const { x: origLeft, y: origTop } = getLogicalPosFromPercent(selectedImage.x, selectedImage.y);
                    selectedImage.x = ((origLeft + dx) / logicalW) * 100;
                    selectedImage.y = ((origTop + dy) / logicalH) * 100;
                    startX = pos.x;
                    startY = pos.y;
                    draw();
                } else if (mode === 'nw') {
                    const dx = pos.x - startX;
                    const dy = pos.y - startY;
                    const { x: origLeft, y: origTop } = getLogicalPosFromPercent(selectedImage.x, selectedImage.y);
                    const origRight = origLeft + (selectedImage.ancho / 100) * logicalW;
                    const origBottom = origTop + (selectedImage.alto / 100) * logicalH;
                    const newLeft = origLeft + dx;
                    const newTop = origTop + dy;
                    selectedImage.x = (newLeft / logicalW) * 100;
                    selectedImage.y = (newTop / logicalH) * 100;
                    selectedImage.ancho = ((origRight - newLeft) / logicalW) * 100;
                    selectedImage.alto = ((origBottom - newTop) / logicalH) * 100;
                    startX = pos.x;
                    startY = pos.y;
                    draw();
                } else if (mode === 'ne') {
                    const dx = pos.x - startX;
                    const dy = pos.y - startY;
                    const { x: origLeft, y: origTop } = getLogicalPosFromPercent(selectedImage.x, selectedImage.y);
                    const origRight = origLeft + (selectedImage.ancho / 100) * logicalW;
                    const origBottom = origTop + (selectedImage.alto / 100) * logicalH;
                    const newRight = origRight + dx;
                    const newTop = origTop + dy;
                    selectedImage.y = (newTop / logicalH) * 100;
                    selectedImage.ancho = ((newRight - origLeft) / logicalW) * 100;
                    selectedImage.alto = ((origBottom - newTop) / logicalH) * 100;
                    startX = pos.x;
                    startY = pos.y;
                    draw();
                } else if (mode === 'sw') {
                    const dx = pos.x - startX;
                    const dy = pos.y - startY;
                    const { x: origLeft, y: origTop } = getLogicalPosFromPercent(selectedImage.x, selectedImage.y);
                    const origRight = origLeft + (selectedImage.ancho / 100) * logicalW;
                    const origBottom = origTop + (selectedImage.alto / 100) * logicalH;
                    const newLeft = origLeft + dx;
                    const newBottom = origBottom + dy;
                    selectedImage.x = (newLeft / logicalW) * 100;
                    selectedImage.ancho = ((origRight - newLeft) / logicalW) * 100;
                    selectedImage.alto = ((newBottom - origTop) / logicalH) * 100;
                    startX = pos.x;
                    startY = pos.y;
                    draw();
                } else if (mode === 'se') {
                    const dx = pos.x - startX;
                    const dy = pos.y - startY;
                    const { x: origLeft, y: origTop } = getLogicalPosFromPercent(selectedImage.x, selectedImage.y);
                    const origRight = origLeft + (selectedImage.ancho / 100) * logicalW;
                    const origBottom = origTop + (selectedImage.alto / 100) * logicalH;
                    const newRight = origRight + dx;
                    const newBottom = origBottom + dy;
                    selectedImage.ancho = ((newRight - origLeft) / logicalW) * 100;
                    selectedImage.alto = ((newBottom - origTop) / logicalH) * 100;
                    startX = pos.x;
                    startY = pos.y;
                    draw();
                }
            } else {
                if (currentTool === 'zoom') {
                    const img = getImageAt(pos.x, pos.y);
                    canvas.style.cursor = img ? 'zoom-in' : 'default';
                } else {
                    const img = getImageAt(pos.x, pos.y);
                    if (img) {
                        const handle = getHandleAt(img, pos.x, pos.y);
                        if (handle) {
                            canvas.style.cursor = getCursorForHandle(handle);
                        } else {
                            canvas.style.cursor = 'move';
                        }
                    } else {
                        canvas.style.cursor = 'default';
                    }
                }
            }
        });

        canvas.addEventListener('mouseup', () => {
            mode = 'none';
            if (currentTool === 'zoom') {
                canvas.style.cursor = 'default';
            }
        });

        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const pos = getMousePos(e);
            const img = getImageAt(pos.x, pos.y);
            if (!img) return;
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            zoom = Math.max(0.5, Math.min(3, zoom + delta));
            updateCanvasSize();
        });

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            images.forEach(img => {
                if (!img.img || !img.img.complete) return;
                const px = (img.x / 100) * logicalW * zoom;
                const py = (img.y / 100) * logicalH * zoom;
                const pw = (img.ancho / 100) * logicalW * zoom;
                const ph = (img.alto / 100) * logicalH * zoom;
                ctx.drawImage(img.img, px, py, pw, ph);
            });
            if (selectedImage) {
                const px = (selectedImage.x / 100) * logicalW * zoom;
                const py = (selectedImage.y / 100) * logicalH * zoom;
                const pw = (selectedImage.ancho / 100) * logicalW * zoom;
                const ph = (selectedImage.alto / 100) * logicalH * zoom;
                ctx.strokeStyle = 'blue';
                ctx.lineWidth = 2;
                ctx.strokeRect(px, py, pw, ph);
                const hs = 10;
                ctx.fillStyle = 'red';
                ctx.fillRect(px - hs / 2, py - hs / 2, hs, hs); // NW
                ctx.fillRect(px + pw - hs / 2, py - hs / 2, hs, hs); // NE
                ctx.fillRect(px - hs / 2, py + ph - hs / 2, hs, hs); // SW
                ctx.fillRect(px + pw - hs / 2, py + ph - hs / 2, hs, hs); // SE
            }
        }

        function loadImage() {
            const url = document.getElementById('urlInput').value.trim();
            if (!url) return;
            const newImgData = {
                name: `cuadro ${images.length + 1}`,
                x: 40,
                y: 40,
                ancho: 20,
                alto: 20,
                url: url,
                img: new Image()
            };
            newImgData.img.crossOrigin = 'anonymous';
            newImgData.img.onload = () => {
                draw();
                updateList();
            };
            newImgData.img.onerror = () => {
                alert('Error al cargar la imagen. Verifica la URL.');
            };
            newImgData.img.src = url;
            images.push(newImgData);
            selectedImage = newImgData;
            document.getElementById('urlInput').value = '';
            draw();
            updateList();
        }

        function updateList() {
            const list = document.getElementById('imageList');
            list.innerHTML = '';
            images.forEach((img, idx) => {
                const div = document.createElement('div');
                const inp = document.createElement('input');
                inp.type = 'text';
                inp.value = img.name;
                inp.onchange = () => {
                    img.name = inp.value;
                    draw();
                };
                const selBtn = document.createElement('button');
                selBtn.textContent = 'Seleccionar';
                selBtn.onclick = () => {
                    selectedImage = img;
                    draw();
                };
                const delBtn = document.createElement('button');
                delBtn.textContent = 'Eliminar';
                delBtn.onclick = () => {
                    const i = images.indexOf(img);
                    images.splice(i, 1);
                    if (selectedImage === img) selectedImage = null;
                    updateList();
                    draw();
                };
                div.appendChild(inp);
                div.appendChild(selBtn);
                div.appendChild(delBtn);
                list.appendChild(div);
            });
        }

        function saveJSON() {
            const menuName = prompt('Nombre del menú:') || 'menu_default';
            const jsonData = {
                nombre: menuName,
                cuadros: images.map(img => ({
                    nombre: img.name,
                    x: img.x,
                    y: img.y,
                    alto: img.alto,
                    ancho: img.ancho,
                    url: img.url
                }))
            };
            const jsonStr = JSON.stringify(jsonData, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${menuName}.json`;
            a.click();
        }

        // Inicializar
        setView('pc');
        selectTool('modificador');
    </script>
</body>
</html>
